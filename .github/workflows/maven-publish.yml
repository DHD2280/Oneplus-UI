name: Android CI

on:
  push:
    tags: '*'

permissions: write-all

jobs:
  publish:
    name: Release OneplusUI Library
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - name: set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Shell Scripts Permissions
        run: chmod +x .github/*.sh

      - name: Changelog Generation
        run: .github/extractChanges.sh

      - name: Version Bump
        run: .github/bumpVersion.sh ${{ github.run_id }}

      - name: Grant Permission for Gradlew to Execute
        run: chmod +x gradlew

      - name: Build AAR ⚙️🛠
        run: ./gradlew :oneplusui:build

      - name: Build publish ⚙️🛠
        run: ./gradlew :oneplusui:publish

      - name: Create Release ✅
        uses: ncipollo/release-action@v1.14.0
        with:
          tag: ${{ github.ref }}
          name: ${{ github.ref_name }}
          prerelease: false
          makeLatest: true
          draft: false
          body: ${{ env.RMessage }}
          artifacts: 'oneplusui/build/outputs/aar/*.aar'

      - name: Upload OneplusUI Library AAR 🗳
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: oneplusui/build/outputs/aar/oneplusui-release.aar
          asset_name: oneplusui-release.aar
          asset_content_type: application/aar

      - name: Commit version bump
        uses: github-actions-x/commit@v2.9
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          push-branch: 'master'
          commit-message: 'Version update: Release'
          force-add: 'true'
          files: oneplusui/build.gradle.kts CHANGELOG.md
          name: GitHub
          email: OxygenCustomizerAIPlugin@dhd.it